image: docker:latest

services:
  - docker:dind

variables:
  DOCKER_DRIVER: overlay2
  DOCKER_TLS_CERTDIR: ""
  MVN_VERSION: "3.6.3-jdk-11-slim"
  MAVEN_OPTS: "-Dmaven.repo.local=$CI_PROJECT_DIR/.m2/repository"
  COMPONENT_NAME: "internetofus/$CI_PROJECT_NAME"

cache:
  paths:
    - .m2/repository/
    - target/

cache:
  key: mavenrepo
  paths:
    - maven.repository/

build_code:
  stage: build
  image: maven:${MVN_VERSION}
  script:
    - mvn -B clean compile test-compile javadoc:javadoc javadoc:test-javadoc

build_docker:
  stage: build
  script:
    - docker login -u $CI_REGISTRY_USER -p $CI_REGISTRY_PASSWORD $CI_REGISTRY
    - PROJECT_VERSION=$(grep -m1 '<version>' pom.xml |cut -d '<' -f2  |cut -d '>' -f2)
    - DOCKER_BUILDKIT=1 docker build -f src/main/docker/Dockerfile -t $CI_REGISTRY/$COMPONENT_NAME:$PROJECT_VERSION .
    - docker push $CI_REGISTRY/$COMPONENT_NAME:$PROJECT_VERSION

build_dev_environment:
  stage: build
  script:
    - docker login -u $CI_REGISTRY_USER -p $CI_REGISTRY_PASSWORD $CI_REGISTRY
    - DOCKER_BUILDKIT=1 docker build -f src/dev/docker/Dockerfile -t $CI_REGISTRY/$COMPONENT_NAME:dev .
    - docker push $CI_REGISTRY/$COMPONENT_NAME:dev

junit_test:
  stage: test
  script:
    - docker login -u $CI_REGISTRY_USER -p $CI_REGISTRY_PASSWORD $CI_REGISTRY
    - docker pull docker.io/mongo:4.4.1
    - docker tag docker.io/mongo:4.4.1 mongo:4.4.1
    - docker pull $CI_REGISTRY/internetofus/profile-manager:0.15.0
    - docker tag $CI_REGISTRY/internetofus/profile-manager:0.15.0 internetofus/profile-manager:0.15.0
    - docker pull $CI_REGISTRY/internetofus/interaction-protocol-engine:0.12.0
    - docker tag $CI_REGISTRY/internetofus/interaction-protocol-engine:0.12.0  internetofus/interaction-protocol-engine:0.12.0
    - docker run -v /var/run/docker.sock:/var/run/docker.sock -v $CI_PROJECT_DIR/.m2/repository:/root/.m2/repository  -v ${PWD}:/app $CI_REGISTRY/$COMPONENT_NAME:dev mvn -B verify
    - awk -F"," '{ instructions += $4 + $5; covered += $5 } END { print covered, "/", instructions, "instructions covered"; print 100*covered/instructions, "% covered" }' target/site/jacoco/jacoco.csv
  artifacts:
    when: always
    reports:
      junit:
        - target/surefire-reports/TEST-*.xml
        - target/failsafe-reports/TEST-*.xml

deploy_pages:
  stage: deploy
  image: maven:${MVN_VERSION}
  script:
    - mvn -B -DskipTests site post-site
    - mv target/site public
  artifacts:
    paths:
      - public 

deploy_tag:
  stage: deploy
  script:
    - docker login -u $DOCKER_USER -p $DOCKER_PASSWORD
    - DOCKER_BUILDKIT=1 docker build -f src/main/docker/Dockerfile -t $COMPONENT_NAME:$CI_COMMIT_TAG .
    - docker push $COMPONENT_NAME:$CI_COMMIT_TAG
  only:
    - tags

deploy_stable:
  stage: deploy
  script:
    - docker login -u $DOCKER_USER -p $DOCKER_PASSWORD
    - DOCKER_BUILDKIT=1 docker build -f src/main/docker/Dockerfile -t $COMPONENT_NAME:latest .
    - docker push $COMPONENT_NAME:latest
  only:
    - master
